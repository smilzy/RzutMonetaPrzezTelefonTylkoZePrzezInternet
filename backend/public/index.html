<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rzut MonetƒÖ Przez Telefon (Tylko ≈ªe Przez Internet ;))</title>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2em auto; }
    input, button { margin: 0.5em 0; }
    .hidden { display: none; }
    .commitment, .reveal, .result { margin: 1em 0; padding: 1em; border: 1px solid #ccc; }
    .big-btn {
      font-size: 1.3em;
      padding: 0.7em 2.5em;
      background: #43a047;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #0002;
      margin: 0.5em 0.5em 0.5em 0;
      transition: background 0.2s, transform 0.1s;
      outline: none;
    }
    .guess-btn img {
      transition: box-shadow 0.2s;
    }
    .guess-btn.selected img, .guess-btn:focus img {
      box-shadow: 0 0 0 4px #43a047;
    }
    .centered-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1em;
      margin: 1.5em 0;
    }
    .centered-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .big-input {
      font-size: 1.3em;
      padding: 0.6em 1.2em;
      border-radius: 10px;
      border: 1.5px solid #bbb;
      margin: 0.5em 0;
      width: 260px;
      text-align: center;
    }
    .room-id-box {
      background: #f1f8e9;
      border: 2px solid #43a047;
      border-radius: 16px;
      padding: 1.2em 2em;
      font-size: 1.5em;
      font-weight: bold;
      color: #1a237e;
      margin: 1.5em auto 1em auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5em;
      cursor: pointer;
      max-width: 500px;
      box-shadow: 0 2px 12px #0001;
      position: relative;
      transition: background 0.2s;
    }
    .room-id-box:hover {
      background: #e8f5e9;
    }
    .copy-btn {
      font-size: 1em;
      padding: 0.4em 1.2em;
      background: #388e3c;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 1em;
      transition: background 0.2s;
    }
    .copy-btn:hover {
      background: #256029;
    }
    .copy-tooltip {
      position: absolute;
      top: -2.2em;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 0.3em 1em;
      border-radius: 6px;
      font-size: 0.95em;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 10;
    }
    .room-id-box.copied .copy-tooltip {
      opacity: 1;
    }
    .steps-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 2em;
      margin: 2em 0 1em 0;
    }
    .step-box {
      background: #f8f8f8;
      border: 2px solid #43a047;
      border-radius: 16px;
      padding: 2em 1.5em 1.5em 1.5em;
      min-width: 200px;
      min-height: 180px;
      box-shadow: 0 2px 12px #0001;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      position: relative;
    }
    .step-box .big-btn {
      margin-top: 1em;
    }
    .step-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #1a237e;
      margin-bottom: 0.7em;
    }
    .step-status {
      font-size: 1em;
      margin-top: 0.7em;
      min-height: 2.2em;
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 1.2em auto 0.5em auto;
      font-size: 2.1em;
      max-width: 95vw;
      word-break: break-word;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.3em;
        padding: 0 0.2em;
      }
    }
    #start-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(255,255,255,0.98);
      z-index: 20000;
      text-align: center;
      padding-top: 6vh;
    }
    #start-modal .coin-gif {
      width: 340px;
      max-width: 90vw;
      margin-bottom: 2em;
      border-radius: 18px;
      box-shadow: 0 4px 24px #0002;
    }
    #start-modal .big-title {
      font-size: 2.5em;
      font-weight: bold;
      color: #1a237e;
      margin-bottom: 2em;
      letter-spacing: 0.04em;
    }
    #start-modal .close-btn {
      position: absolute;
      top: 2.5vh;
      right: 3vw;
      font-size: 2.2em;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-weight: bold;
      transition: color 0.2s;
      z-index: 10;
    }
    #start-modal .close-btn:hover {
      color: #43a047;
    }
    .guess-btn-main {
      margin: 1em;
      border: none;
      background: none;
      cursor: pointer;
      display: inline-block;
      box-shadow: none;
      padding: 0;
    }
    .guess-btn-main img {
      width: 220px;
      border: 3px solid #888;
      border-radius: 50%;
      transition: border 0.2s, box-shadow 0.2s, opacity 0.2s;
      background: #fff;
    }
    .guess-btn-main.selected img, .guess-btn-main:focus img {
      border: 3px solid #43a047;
      box-shadow: 0 0 0 4px #43a047;
      background: #e8f5e9;
    }
    .guess-btn-main:disabled img {
      opacity: 0.5;
    }
    /* Usuwam zielone t≈Ço z .big-btn dla guess-btn-main */
    .guess-btn-main.big-btn {
      background: none;
      color: inherit;
      box-shadow: none;
    }
    .guess-result {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 2em;
    }
    .guess-result img {
      margin-top: 1em;
      width: 180px;
      border-radius: 10px;
    }
    .guess-result button#play-again-btn-main {
      margin-top: 2em;
      font-size: 1.3em;
      padding: 0.7em 2.5em;
      background: #43a047;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s;
    }
    .guess-result button#play-again-btn-main:hover {
      background: #2e7031;
    }
    body.dark-mode {
      background: #181c24;
      color: #e0e6ef;
    }
    body.dark-mode .big-btn,
    body.dark-mode .copy-btn,
    body.dark-mode .step-box {
      background: #232a36;
      color: #e0e6ef;
      border-color: #3a445a;
      box-shadow: 0 2px 12px #0006;
    }
    body.dark-mode .room-id-box {
      background: #232a36;
      color: #e0e6ef;
      border-color: #3a445a;
    }
    body.dark-mode .guess-btn-main img,
    body.dark-mode .guess-btn img {
      background: #232a36;
      border-color: #3a445a;
    }
    body.dark-mode .guess-btn-main.selected img,
    body.dark-mode .guess-btn-main:focus img {
      background: #232a36;
      border-color: #43a047;
    }
    body.dark-mode .centered-row,
    body.dark-mode .centered-col {
      background: none;
    }
    body.dark-mode .guess-result {
      color: #e0e6ef;
    }
    body.dark-mode .guess-result button#play-again-btn-main {
      background: #2e7031;
      color: #fff;
    }
    body.dark-mode .guess-result button#play-again-btn-main:hover {
      background: #43a047;
    }
    body.dark-mode .timer-bar {
      background: #232a36;
    }
    body.dark-mode .timer-bar-inner {
      background: linear-gradient(90deg, #43a047, #fbc02d);
    }
    body.dark-mode #start-modal,
    body.dark-mode #debug-modal {
      background: rgba(24,28,36,0.98) !important;
      color: #e0e6ef;
    }
    body.dark-mode input,
    body.dark-mode .big-input {
      background: #232a36;
      color: #e0e6ef;
      border-color: #3a445a;
    }
    body.dark-mode .copy-tooltip {
      background: #232a36;
      color: #e0e6ef;
    }
    /* Prze≈ÇƒÖcznik motywu */
    #theme-toggle {
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 10010;
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
      color: #1a237e;
      transition: color 0.2s;
    }
    body.dark-mode #theme-toggle {
      color: #fbc02d;
    }
    .loader {
      display: inline-block;
      width: 1.2em;
      height: 1.2em;
      border: 3px solid #43a047;
      border-radius: 50%;
      border-top: 3px solid transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 0.7em;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    body.dark-mode .loader {
      border: 3px solid #fbc02d;
      border-top: 3px solid transparent;
    }
    .selected-pending img {
      border: 3px solid #fbc02d !important;
      box-shadow: 0 0 0 4px #fbc02d !important;
      background: #fffbe6 !important;
    }
    body.dark-mode .selected-pending img {
      border: 3px solid #fbc02d !important;
      box-shadow: 0 0 0 4px #fbc02d !important;
      background: #232a36 !important;
    }
    #choose-row {
      display: flex !important;
      flex-direction: row !important;
      justify-content: center;
      gap: 2em;
    }
    .selected-win img {
      border: 3px solid #43a047 !important;
      box-shadow: 0 0 0 4px #43a047 !important;
    }
    .selected-lose img {
      border: 3px solid #b71c1c !important;
      box-shadow: 0 0 0 4px #b71c1c !important;
    }
    .player-id-label {
      font-size: 0.85em;
      font-weight: normal;
      display: block;
      margin-left: 0;
      margin-top: 0.3em;
      color: #888;
    }
    body.dark-mode .player-id-label {
      color: #aaa;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" title="Prze≈ÇƒÖcz motyw">üåô</button>
  <h1>Rzut MonetƒÖ Przez Telefon<br><span style="font-size:0.7em; font-weight:normal;">(Tylko ≈ªe Przez Internet ;))</span></h1>
  <div id="room-setup" class="centered-col">
    <button id="create-room" class="big-btn" style="margin-bottom:2em;">Utw√≥rz pok√≥j</button>
    <div class="centered-row">
      <input id="room-id" class="big-input" placeholder="Wpisz ID pokoju" />
      <button id="join-room" class="big-btn">Do≈ÇƒÖcz do pokoju</button>
    </div>
    <input id="player-nick" class="big-input" placeholder="Tw√≥j nick (opcjonalnie)" style="margin-top:0.5em;" />
    <div id="room-link" style="display:none"></div>
  </div>
  <div id="game" class="hidden" style="position:relative;">
    <div id="boom-skull" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.97); z-index:9999; text-align:center; padding-top:5em;">
      <img id="skull-img" src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExa2o1d3J4d3M2MWVkdjkzMWE4NDZwZmF3MjM0aHoxZ3l4YTh3ZmVjaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/QNuQ2a8DZUJU0QOHPd/giphy.gif" alt="BOOM!" style="width:120px;">
      <div style="font-size:2em; color:#b71c1c; font-weight:bold; margin-top:1em;">BOOM! nie ≈ºyjesz, hahahahaha</div>
    </div>
    <div id="game-content">
      <div id="room-info" class="room-id-box centered-row" style="display:none; flex-direction:row; align-items:center; justify-content:center; gap:1em;">
        <span id="room-id-label" style="font-size:1.3em;">ID pokoju: <b id="room-id-game" style="font-size:1.3em;"></b></span>
        <button id="copy-room-id" class="copy-btn">Kopiuj</button>
        <span class="copy-tooltip" id="copy-tooltip">Kliknij, aby skopiowaƒá</span>
      </div>
    </div>
  </div>
  <div id="game-flow" style="text-align:center;margin-top:2em;">
    <img id="cwaniak-img" src="https://static.pomagam.pl/media/project_photos/cache/UNvPmRE2Cgsk.jpg" alt="cwaniak" style="width:340px; border-radius:10px; margin-bottom:1em;">
    <button id="throw-coin-btn" class="big-btn" style="font-size:2em;">JA JESTEM CWANIAK</button>
    <div id="waiting-cwaniak" style="display:none; font-size:1.3em; color:#1a237e; margin-top:2em;">
      <span class="loader"></span>
      OCZEKIWANIE NA DRUGIEGO CWANIAKA
    </div>
    <div id="choose-section" style="display:none;">
      <div id="pojedynek-message" style="font-size:1.2em;font-weight:bold;color:#b71c1c;margin-bottom:1em;"></div>
      <img id="coin-gif" src="https://media4.giphy.com/media/MOsuJf3qp3b1fQx2Iv/giphy.gif?cid=6c09b952fwmeraqx4dliut78mqlcmhs8s0imidrlxqupfu79&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s" alt="Rzut monetƒÖ" style="width:340px; border-radius:18px; margin-bottom:1em; box-shadow:0 4px 24px #0002;">
      <div class="timer-bar" style="width:70%;height:18px;background:#eee;border-radius:9px;margin:1.2em auto 0;overflow:hidden;">
        <div class="timer-bar-inner" id="guess-timer-bar-main" style="height:100%;background:linear-gradient(90deg,#43a047,#fbc02d);width:100%;transition:width 0.2s linear;"></div>
      </div>
      <div id="choose-title" style="font-size:2.1em;font-weight:bold;color:#1a237e;margin-bottom:1.2em;">Wybierz stronƒô monety</div>
      <div id="choose-row" style="display:flex;justify-content:center;gap:2em;">
        <button class="guess-btn guess-btn-main" id="guess-awers-main">
          <img src="https://numizmatyczny.com/userdata/public/gfx/13406/Moneta-5-zl-Opactwo-Benedyktynow-w-Tyncu-awers.jpg" alt="Awers" style="width:220px;border-radius:50%;border:3px solid #888;">
          <div style="font-size:1.3em;margin-top:0.5em;">Awers</div>
        </button>
        <button class="guess-btn guess-btn-main" id="guess-rewers-main">
          <img src="https://numizmatyczny.com/userdata/public/gfx/13407/Moneta-5-zl-Opactwo-Benedyktynow-w-Tyncu-rewers.jpg" alt="Rewers" style="width:220px;border-radius:50%;border:3px solid #888;">
          <div style="font-size:1.3em;margin-top:0.5em;">Rewers</div>
        </button>
      </div>
      <div id="waiting-info-main" style="margin-top:1.5em;font-size:1.2em;color:#1a237e;display:none;"><span class="loader"></span> Oczekiwanie na wyb√≥r drugiego cwaniaka...</div>
      <div id="guess-result-main" class="guess-result"></div>
    </div>
  </div>
  <!-- Modal startowy -->
  <div id="start-modal">
    <button class="close-btn" id="close-start-modal" title="Zamknij">&times;</button>
    <img class="coin-gif" src="https://media4.giphy.com/media/MOsuJf3qp3b1fQx2Iv/giphy.gif?cid=6c09b952fwmeraqx4dliut78mqlcmhs8s0imidrlxqupfu79&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s" alt="Rzut monetƒÖ">
    <div class="big-title">RZUƒÜ</div>
  </div>
  <!-- Dodaj przycisk debug info w rogu -->
  <button id="open-debug-modal" style="position:fixed;top:18px;right:18px;z-index:10001;font-size:1.1em;padding:0.5em 1.2em;background:#1a237e;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0002;cursor:pointer;">Debug info</button>
  <!-- Modal debug info -->
  <div id="debug-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:10002;text-align:center;">
    <div style="background:#fff;max-width:520px;margin:7vh auto 0 auto;padding:2em 2em 1.5em 2em;border-radius:18px;box-shadow:0 4px 24px #0003;position:relative;">
      <button id="close-debug-modal" style="position:absolute;top:0.7em;right:1em;font-size:2em;background:none;border:none;color:#888;cursor:pointer;">&times;</button>
      <div style="font-size:1.3em;font-weight:bold;margin-bottom:1em;color:#1a237e;">Debug info</div>
      <div style="background:#f8f8f8;border:1px solid #ccc;border-radius:8px;padding:1em;font-size:1em;text-align:left;">
        <div>Commitment: <span id="debug-commitment"></span></div>
        <div>Bit: <span id="debug-bit"></span></div>
        <div>Nonce: <span id="debug-nonce"></span></div>
      </div>
      <div class="steps-row" style="margin-top:2em;">
        <div class="step-box">
          <div class="step-title">1. Commitment</div>
          <button id="commit-btn" class="big-btn">Wy≈õlij commitment</button>
          <div id="commitment-status" class="step-status"></div>
        </div>
        <div class="step-box">
          <div class="step-title">2. Reveal</div>
          <button id="reveal-btn" class="big-btn hidden">Ujawnij bit</button>
          <div id="reveal-status" class="step-status"></div>
        </div>
        <div class="step-box">
          <div class="step-title">3. Wynik</div>
          <button id="check-result" class="big-btn hidden">Sprawd≈∫ wynik</button>
          <div id="result-status" class="step-status"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Prosty klient JS
    let roomId = null;
    let playerId = null;
    let bit = null;
    let nonce = null;
    let commitment = null;
    let revealed = false;

    function randomBit() { return Math.random() < 0.5 ? 0 : 1; }
    function randomNonce() { return Math.random().toString(36).slice(2, 10); }
    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    document.getElementById('create-room').onclick = async () => {
      const res = await fetch('/api/create_room', {method: 'POST'});
      const data = await res.json();
      roomId = data.room_id;
      document.getElementById('room-link').innerHTML = `ID pokoju: <b>${roomId}</b> (przeka≈º koledze)`;
      document.getElementById('room-link').style.display = 'block';
      startGame(); // Przechod≈∫ od razu do gry
    };
    document.getElementById('join-room').onclick = () => {
      roomId = document.getElementById('room-id').value.trim();
      if(roomId) startGame();
    };

    function startGame() {
      document.getElementById('room-setup').style.display = 'none';
      document.getElementById('game-flow').style.display = '';
      const customId = document.getElementById('player-nick').value;
      playerId = customId && customId.trim() ? customId.trim() : 'cwaniak_' + Math.random().toString(36).slice(2, 8);
      document.getElementById('game').classList.remove('hidden');
      document.getElementById('room-id-game').textContent = roomId;
      document.getElementById('room-info').style.display = '';
      if(playerId.toLowerCase() === 'boss_mafii') {
        document.getElementById('game-content').style.display = 'none';
        document.getElementById('boom-skull').style.display = 'block';
      }
      showRoomInfo();
      document.getElementById('game-content').classList.add('centered-col');
      // NIE pokazuj modala startowego
      // Ukryj wyb√≥r orze≈Ç/reszka i poka≈º tylko gif i przycisk RZUƒÜ
      document.getElementById('choose-section').style.display = 'none';
      document.getElementById('coin-gif').style.display = '';
      document.getElementById('throw-coin-btn').style.display = '';
      // Upewnij siƒô, ≈ºe obrazek cwaniaka jest widoczny
      if(document.getElementById('cwaniak-img')) document.getElementById('cwaniak-img').style.display = '';
    }

    document.getElementById('commit-btn').onclick = async () => {
      bit = randomBit();
      nonce = randomNonce();
      commitment = await sha256(bit + ':' + nonce);
      await fetch(`/api/${roomId}/commit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, commitment})
      });
      document.getElementById('commitment-status').textContent = `Commitment wys≈Çany! (bit i nonce ukryte)`;
      pollCommitments();
    };

    async function pollCommitments() {
      let ready = false;
      while(!ready) {
        const res = await fetch(`/api/${roomId}/commitments`);
        const data = await res.json();
        if(Object.keys(data.commitments).length === 2) ready = true;
        else await new Promise(r => setTimeout(r, 1000));
      }
      document.getElementById('reveal-btn').classList.remove('hidden');
      pollReveals();
    }

    document.getElementById('reveal-btn').onclick = async () => {
      await fetch(`/api/${roomId}/reveal`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, bit, nonce})
      });
      document.getElementById('reveal-status').textContent = `Bit ujawniony! (bit: ${bit}, nonce: ${nonce})`;
      revealed = true;
      pollReveals();
    };

    async function pollReveals() {
      let ready = false;
      while(!ready) {
        const res = await fetch(`/api/${roomId}/reveals`);
        const data = await res.json();
        if(Object.keys(data.reveals).length === 2) ready = true;
        else await new Promise(r => setTimeout(r, 1000));
      }
      document.getElementById('check-result').classList.remove('hidden');
      showGuessSection();
    }

    // Usuwam ca≈ÇƒÖ logikƒô modala i przenoszƒô jƒÖ na g≈Ç√≥wny widok:
    let guessMain = null;
    let guessTimerMain = null;
    let guessPollingMain = null;
    let guessPollingTimeoutMain = null;
    let timeLeftMain = 10;
    function showGuessSection() {
      guessMain = null;
      document.getElementById('choose-section').style.display = '';
      document.getElementById('guess-result-main').innerHTML = '';
      document.getElementById('guess-awers-main').classList.remove('selected');
      document.getElementById('guess-rewers-main').classList.remove('selected');
      document.getElementById('guess-awers-main').disabled = false;
      document.getElementById('guess-rewers-main').disabled = false;
      document.getElementById('guess-rewers-main').style.opacity = '1';
      document.getElementById('guess-awers-main').style.opacity = '1';
      if(document.getElementById('waiting-info-main')) document.getElementById('waiting-info-main').style.display = 'none';
      timeLeftMain = 10;
      updateGuessTimerBarMain(timeLeftMain);
      if (guessTimerMain) clearInterval(guessTimerMain);
      if (guessPollingMain) clearInterval(guessPollingMain);
      if (guessPollingTimeoutMain) clearTimeout(guessPollingTimeoutMain);
      guessTimerMain = setInterval(() => {
        timeLeftMain -= 0.1;
        updateGuessTimerBarMain(timeLeftMain);
        if (timeLeftMain <= 0) {
          clearInterval(guessTimerMain);
          finishGuessMain();
        }
      }, 100);
      guessPollingMain = setInterval(pollGuessResultMain, 700);
      guessPollingTimeoutMain = setTimeout(() => {
        if (guessPollingMain) clearInterval(guessPollingMain);
        document.getElementById('guess-result-main').innerHTML = '<img src="/img/wyleciales.jpg" style="width:300px; margin-top:1em; border-radius:12px;">' +
          '<div style="margin-top:1em; font-size:1.5em; color:#b71c1c; font-weight:bold;">BARDZO SIƒò STARA≈ÅE≈ö, LECZ Z GRY WYLECIA≈ÅE≈ö</div>';
      }, 15000);
      updatePojedynekMessage();
    }
    function updateGuessTimerBarMain(timeLeft) {
      const percent = Math.max(0, Math.min(1, timeLeft/10));
      document.getElementById('guess-timer-bar-main').style.width = (percent*100)+"%";
    }
    document.getElementById('throw-coin-btn').onclick = function() {
      document.getElementById('throw-coin-btn').style.display = 'none';
      // NIE ukrywaj cwaniaka tutaj!
      document.getElementById('waiting-cwaniak').style.display = '';
      // Wy≈õlij commitment
      bit = randomBit();
      nonce = randomNonce();
      commitment = sha256(bit + ':' + nonce).then(function(c) {
        commitment = c;
        fetch(`/api/${roomId}/commit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player: playerId, commitment})
        });
        pollCommitmentsCwaniak();
      });
    };
    function pollCommitmentsCwaniak() {
      let interval = setInterval(async function() {
        const res = await fetch(`/api/${roomId}/commitments`);
        const data = await res.json();
        if(Object.keys(data.commitments).length === 2) {
          clearInterval(interval);
          document.getElementById('waiting-cwaniak').style.display = 'none';
          document.getElementById('cwaniak-img').style.display = 'none'; // Ukryj cwaniaka dopiero tutaj
          showGuessSection();
        }
      }, 1000);
    }
    document.getElementById('guess-awers-main').onclick = async function() {
      if (guessMain !== null) return;
      guessMain = 0;
      document.getElementById('guess-awers-main').classList.add('selected-pending');
      document.getElementById('guess-rewers-main').classList.remove('selected-pending');
      document.getElementById('guess-awers-main').disabled = true;
      document.getElementById('guess-rewers-main').disabled = true;
      document.getElementById('guess-rewers-main').style.opacity = '0.5';
      document.getElementById('guess-awers-main').style.opacity = '1';
      if(document.getElementById('waiting-info-main')) document.getElementById('waiting-info-main').style.display = '';
      // Najpierw wy≈õlij reveal
      await fetch(`/api/${roomId}/reveal`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, bit, nonce})
      });
      // Potem guess
      await fetch(`/api/${roomId}/guess`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, guess: guessMain})
      });
      finishGuessMain(false);
    };
    document.getElementById('guess-rewers-main').onclick = async function() {
      if (guessMain !== null) return;
      guessMain = 1;
      document.getElementById('guess-rewers-main').classList.add('selected-pending');
      document.getElementById('guess-awers-main').classList.remove('selected-pending');
      document.getElementById('guess-rewers-main').disabled = true;
      document.getElementById('guess-awers-main').disabled = true;
      document.getElementById('guess-awers-main').style.opacity = '0.5';
      document.getElementById('guess-rewers-main').style.opacity = '1';
      if(document.getElementById('waiting-info-main')) document.getElementById('waiting-info-main').style.display = '';
      // Najpierw wy≈õlij reveal
      await fetch(`/api/${roomId}/reveal`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, bit, nonce})
      });
      // Potem guess
      await fetch(`/api/${roomId}/guess`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player: playerId, guess: guessMain})
      });
      finishGuessMain(false);
    };
    function finishGuessMain(hideBtns = true) {
      if (guessTimerMain) clearInterval(guessTimerMain);
      if(hideBtns) document.getElementById('choose-row').style.display = 'none';
      if (guessMain !== null) {
        fetch(`/api/${roomId}/guess`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player: playerId, guess: guessMain})
        });
      } else {
        // Timeout: gracz nie dokona≈Ç wyboru
        document.getElementById('guess-result-main').innerHTML = '<img src="/img/wyleciales.jpg" style="width:300px; margin-top:1em; border-radius:12px;">' +
          '<div style="margin-top:1em; font-size:1.5em; color:#b71c1c; font-weight:bold;">BARDZO SIƒò STARA≈ÅE≈ö, LECZ Z GRY WYLECIA≈ÅE≈ö</div>';
        document.getElementById('guess-result-main').style.display = '';
        return;
      }
      updatePojedynekMessage();
    }
    async function pollGuessResultMain() {
      const res = await fetch(`/api/${roomId}/guess_result`);
      if (res.status === 200) {
        const data = await res.json();
        if (guessPollingMain) clearInterval(guessPollingMain);
        if (guessPollingTimeoutMain) clearTimeout(guessPollingTimeoutMain);
        showGuessResultMain(data);
        // Upewnij siƒô, ≈ºe sekcja wyniku jest widoczna
        document.getElementById('guess-result-main').style.display = '';
      }
    }
    function showGuessResultMain(data) {
      // Ukryj obrazek cwaniaka
      if (document.getElementById('cwaniak-img')) document.getElementById('cwaniak-img').style.display = 'none';
      // Ukryj obrazek rzutu monetƒÖ
      if (document.getElementById('coin-gif')) document.getElementById('coin-gif').style.display = 'none';
      // NIE ukrywaj wyboru monety ani tytu≈Çu!
      // Wygaszaj niewybranƒÖ monetƒô i ustaw obramowanie zale≈ºnie od wyniku
      const myGuess = data.guesses[playerId];
      const win = (myGuess !== undefined && parseInt(myGuess) === data.result);
      // Najpierw usu≈Ñ stare klasy
      document.getElementById('guess-awers-main').classList.remove('selected', 'selected-pending', 'selected-win', 'selected-lose');
      document.getElementById('guess-rewers-main').classList.remove('selected', 'selected-pending', 'selected-win', 'selected-lose');
      if (guessMain === 0) {
        if (win) {
          document.getElementById('guess-awers-main').classList.add('selected-win');
        } else {
          document.getElementById('guess-awers-main').classList.add('selected-lose');
        }
        document.getElementById('guess-rewers-main').style.opacity = '0.5';
        document.getElementById('guess-awers-main').style.opacity = '1';
      } else if (guessMain === 1) {
        if (win) {
          document.getElementById('guess-rewers-main').classList.add('selected-win');
        } else {
          document.getElementById('guess-rewers-main').classList.add('selected-lose');
        }
        document.getElementById('guess-awers-main').style.opacity = '0.5';
        document.getElementById('guess-rewers-main').style.opacity = '1';
      }
      if(document.getElementById('choose-title')) document.getElementById('choose-title').style.display = 'none';
      if(document.getElementById('choose-row')) document.getElementById('choose-row').style.display = 'none';
      var timerBar = document.querySelector('.timer-bar');
      if(timerBar) timerBar.style.display = 'none';
      // Usu≈Ñ napis oczekiwania
      if(document.getElementById('waiting-info-main')) document.getElementById('waiting-info-main').style.display = 'none';
      // Przygotuj wynik
      let html = '';
      if (myGuess === undefined) {
        html = '<img src="/img/wyleciales.jpg" style="width:300px; margin-top:1em; border-radius:12px;">' +
               '<div style="margin-top:1em; font-size:1.5em; color:#b71c1c; font-weight:bold;">BARDZO SIƒò STARA≈ÅE≈ö, LECZ Z GRY WYLECIA≈ÅE≈ö</div>';
      } else if (win) {
        html = '<img src="https://i1.memy.pl/obrazki/a87d950287_masz_tu_piatke.jpg" style="width:220px; margin-top:1em; border-radius:12px;">' +
               '<div style="margin-top:1em; font-size:1.5em; color:#388e3c; font-weight:bold;">BRAWO! WYGRA≈ÅE≈ö IPHONA!</div>';
      } else {
        html = '<img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExa2o1d3J4d3M2MWVkdjkzMWE4NDZwZmF3MjM0aHoxZ3l4YTh3ZmVjaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/QNuQ2a8DZUJU0QOHPd/giphy.gif" style="width:120px; margin-top:1em; border-radius:12px;">' +
               '<div style="margin-top:1em; font-size:1.5em; color:#b71c1c; font-weight:bold;">BOOM! nie ≈ºyjesz, hahahahaha</div>';
      }
      html += '<br><button id="play-again-btn-main" class="big-btn" style="margin-top:2em;">JESZCZE RAZ?</button>';
      document.getElementById('guess-result-main').innerHTML = html;
      document.getElementById('play-again-btn-main').onclick = async () => {
        await fetch(`/api/${roomId}/reset`, {method: 'POST'});
        resetGameMain();
        if (document.getElementById('cwaniak-img')) document.getElementById('cwaniak-img').style.display = '';
      };
    }
    function resetGameMain() {
      document.getElementById('choose-section').style.display = 'none';
      document.getElementById('guess-result-main').innerHTML = '';
      document.getElementById('coin-gif').style.display = '';
      document.getElementById('throw-coin-btn').style.display = '';
      // WYCZY≈öƒÜ RAMKI Z MONET
      document.getElementById('guess-awers-main').classList.remove('selected-win', 'selected-lose', 'selected-pending', 'selected');
      document.getElementById('guess-rewers-main').classList.remove('selected-win', 'selected-lose', 'selected-pending', 'selected');
      document.getElementById('guess-awers-main').style.opacity = '1';
      document.getElementById('guess-rewers-main').style.opacity = '1';
      guessMain = null;
      updatePojedynekMessage();
    }
    // Uzupe≈Çniaj debug info po ka≈ºdej akcji:
    document.getElementById('debug-commitment').textContent = commitment || '';
    document.getElementById('debug-bit').textContent = bit !== null ? bit : '';
    document.getElementById('debug-nonce').textContent = nonce || '';

    function showRoomInfo() {
      const roomInfo = document.getElementById('room-info');
      const roomIdGame = document.getElementById('room-id-game');
      roomInfo.style.display = '';
      roomInfo.classList.remove('copied');
      document.getElementById('copy-tooltip').textContent = 'Kliknij, aby skopiowaƒá';
      function copyId() {
        navigator.clipboard.writeText(roomIdGame.textContent);
        roomInfo.classList.add('copied');
        document.getElementById('copy-tooltip').textContent = 'Skopiowano!';
        setTimeout(() => {
          roomInfo.classList.remove('copied');
          document.getElementById('copy-tooltip').textContent = 'Kliknij, aby skopiowaƒá';
        }, 1200);
      }
      roomInfo.onclick = copyId;
      document.getElementById('copy-room-id').onclick = (e) => { e.stopPropagation(); copyId(); };
    }

    document.getElementById('close-start-modal').onclick = () => {
      document.getElementById('start-modal').style.display = 'none';
    };

    // JS: obs≈Çuga debug modala
    const debugModal = document.getElementById('debug-modal');
    document.getElementById('open-debug-modal').onclick = () => { debugModal.style.display = 'block'; };
    document.getElementById('close-debug-modal').onclick = () => { debugModal.style.display = 'none'; };

    // Motyw jasny/ciemny
    function setTheme(dark) {
      document.body.classList.toggle('dark-mode', dark);
      document.getElementById('theme-toggle').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    document.getElementById('theme-toggle').onclick = () => {
      setTheme(!document.body.classList.contains('dark-mode'));
    };
    // Ustaw motyw z localStorage lub systemowy
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setTheme(true);
      } else {
        setTheme(false);
      }
    })();

    // --- POJEDYNEK MESSAGE LOGIC ---
    async function updatePojedynekMessage() {
      const pojedynekDiv = document.getElementById('pojedynek-message');
      try {
        const res = await fetch(`/api/${roomId}/commitments`);
        const data = await res.json();
        const players = Object.keys(data.commitments || {});
        if (players.length === 1) {
          pojedynekDiv.textContent = 'JESTE≈ö JEDYNYM CWANIAKIEM W TYM POKOJU';
        } else if (players.length === 2) {
          const nicks = players.map(pid => {
            const nick = data.commitments[pid]?.nick;
            return nick && nick.trim() ? nick : pid;
          });
          pojedynekDiv.innerHTML = 'POJEDYNEK CWANIAK√ìW<br>' + nicks[0] + ' <span style="color:#888;">vs</span> ' + nicks[1];
        } else {
          pojedynekDiv.textContent = '';
        }
      } catch (e) {
        pojedynekDiv.textContent = '';
      }
    }
    // Wywo≈Çuj updatePojedynekMessage w odpowiednich momentach:
    // - po wej≈õciu do pokoju
    // - po commitach
    // - po resecie
    // - po rozpoczƒôciu gry
    // - po guessach
    // Dodaj do showGuessSection i resetGameMain:
    const origShowGuessSection = showGuessSection;
    showGuessSection = function() {
      origShowGuessSection.apply(this, arguments);
      updatePojedynekMessage();
    };
    const origResetGameMain = resetGameMain;
    resetGameMain = function() {
      origResetGameMain.apply(this, arguments);
      updatePojedynekMessage();
    };
    // --- KONIEC POJEDYNEK MESSAGE LOGIC ---
  </script>
</body>
<script src="test.js"></script>
</html> 
